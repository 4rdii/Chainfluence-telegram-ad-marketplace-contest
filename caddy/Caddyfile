pgadmin.debazaar.click, debazaar.click {
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }
    
    @pgadmin host pgadmin.debazaar.click
    handle @pgadmin {
        reverse_proxy pgadmin:80
    }

    @api host debazaar.click
    handle @api {
        # Handle CORS preflight requests
        @options method OPTIONS
        handle @options {
            header Access-Control-Allow-Origin "{http.request.header.Origin}"
            header Access-Control-Allow-Methods "GET, POST, PATCH, PUT, DELETE, OPTIONS"
            header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
            header Access-Control-Allow-Credentials "true"
            header Access-Control-Max-Age "86400"
            respond 204
        }
        
        # Add CORS headers to all responses
        reverse_proxy backend:3000 {
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            header_up X-Real-IP {remote_host}
            header_down Access-Control-Allow-Origin "{http.request.header.Origin}"
            header_down Access-Control-Allow-Credentials "true"
            header_down Access-Control-Allow-Methods "GET, POST, PATCH, PUT, DELETE, OPTIONS"
            header_down Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
        }
    }

    handle {
        respond "No route configured for this host" 404
    }
}
