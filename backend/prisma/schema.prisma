generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            BigInt   @id // Telegram user id
  username      String?
  walletAddress String?  @map("wallet_address")
  isPublisher   Boolean  @default(false) @map("is_publisher")
  isAdvertiser  Boolean  @default(true) @map("is_advertiser")
  memberSince   DateTime? @map("member_since")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  channels Channel[]

  @@map("users")
}

model Deal {
  id                 Int       @id @default(autoincrement())
  dealId             Int       @unique @map("deal_id")
  publisherId        BigInt    @map("publisher_id")
  advertiserId       BigInt    @map("advertiser_id")
  channelId          BigInt?   @map("channel_id")
  verificationChatId BigInt    @map("verification_chat_id")
  status             String    @default("active")

  // ── Escrow & on-chain fields ──
  escrowAddress      String?   @map("escrow_address")
  amount             String?   // nanoTON as string
  duration           Int?      // seconds
  contentHash        String?   @map("content_hash")
  postId             Int?      @map("post_id")       // Telegram message ID
  postedAt           Int?      @map("posted_at")     // Unix timestamp

  // ── Party wallet addresses (user's real connected TON wallets) ──
  publisherWallet    String?   @map("publisher_wallet")
  advertiserWallet   String?   @map("advertiser_wallet")

  // ── Cryptographic signatures (hex-encoded ed25519 from TonConnect signData) ──
  publisherSignature  String?  @map("publisher_signature")
  publisherPublicKey  String?  @map("publisher_public_key")
  publisherSignTimestamp Int?   @map("publisher_sign_timestamp")
  publisherSignDomain   String? @map("publisher_sign_domain")

  advertiserSignature String?  @map("advertiser_signature")
  advertiserPublicKey String?  @map("advertiser_public_key")
  advertiserSignTimestamp Int?  @map("advertiser_sign_timestamp")
  advertiserSignDomain   String? @map("advertiser_sign_domain")

  // ── Creative data ──
  creativeText       String?   @map("creative_text")
  creativeImages     Json?     @default("[]") @map("creative_images")

  releasedAt         DateTime? @map("released_at")
  refundedAt         DateTime? @map("refunded_at")
  txHash             String?   @map("tx_hash")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  reviews Review[]

  @@map("deals")
}

model Review {
  id         Int      @id @default(autoincrement())
  dealId     Int      @map("deal_id")
  reviewerId BigInt   @map("reviewer_id")
  revieweeId BigInt   @map("reviewee_id")
  rating     Int
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at")

  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    BigInt    @map("user_id")
  type      String
  title     String
  body      String?
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("notifications")
}

model Channel {
  id                    BigInt    @id
  ownerId               BigInt    @map("owner_id")
  username              String?
  title                 String?
  category              String?
  subscribers           Int?
  avgViews              Int?      @map("avg_views")
  postsPerWeek          Int?      @map("posts_per_week")
  pricing               Json?     @default("[]")
  isVerified            Boolean   @default(false) @map("is_verified")
  isActive              Boolean   @default(true) @map("is_active")
  statsUpdatedAt        DateTime? @map("stats_updated_at")
  languageDistribution  Json?     @map("language_distribution") // {language: percentage}
  topPostsViews         Json?     @map("top_posts_views")       // array of view counts
  engagementRate        Float?    @map("engagement_rate")       // avg engagement %
  avgReach              Int?      @map("avg_reach")             // viewsPerPost.current
  sharesPerPost         Int?      @map("shares_per_post")       // sharesPerPost.current
  reactionsPerPost      Int?      @map("reactions_per_post")    // reactionsPerPost.current
  notificationsEnabled  Float?    @map("notifications_enabled") // enabledNotifications percentage
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("channels")
}

model Campaign {
  id                  Int      @id @default(autoincrement())
  advertiserId        BigInt   @map("advertiser_id")
  title               String
  description         String?
  category            String?
  status              String   @default("active")
  budget              String?  // e.g. "100" TON
  creativeText        String?  @map("creative_text")
  contentGuidelines   String?  @map("content_guidelines")
  creativeImages      Json?    @default("[]") @map("creative_images")
  preferredFormats    Json?    @default("[]") @map("preferred_formats")
  minSubscribers      Int?     @map("min_subscribers")
  minEngagement       Float?   @map("min_engagement")
  preferredCategories Json?    @default("[]") @map("preferred_categories")
  deadline            String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  offers Offer[]

  @@map("campaigns")
}

model Offer {
  id          Int     @id @default(autoincrement())
  campaignId  Int     @map("campaign_id")
  publisherId BigInt  @map("publisher_id")
  channelId   BigInt  @map("channel_id")
  status      String  @default("pending")
  amount      String?
  format      String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("offers")
}
